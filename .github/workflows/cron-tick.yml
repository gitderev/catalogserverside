name: Cron Tick (every 1 minute)

on:
  schedule:
    - cron: "* * * * *"
  workflow_dispatch: {}

jobs:
  cron-tick:
    runs-on: ubuntu-latest
    env:
      TICK_MAX_CALLS: "4"
      TICK_SLEEP_SEC: "75"
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.CRON_TICK_URL }}" ]; then
            echo "::error::Secret CRON_TICK_URL is not configured. Go to Settings > Secrets and variables > Actions and add CRON_TICK_URL (the full URL of your cron-tick Edge Function, e.g. https://<project-id>.supabase.co/functions/v1/cron-tick)."
            exit 1
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "::error::Secret CRON_SECRET is not configured. Go to Settings > Secrets and variables > Actions and add CRON_SECRET (must match the CRON_SECRET Supabase secret)."
            exit 1
          fi

      - name: Call cron-tick (multi-tick loop)
        run: |
          for ATTEMPT in $(seq 1 "$TICK_MAX_CALLS"); do
            TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            BODY_FILE=$(mktemp)
            STATUS=$(curl -sS -o "$BODY_FILE" -w "%{http_code}" -X POST "${{ secrets.CRON_TICK_URL }}" \
              -H "Content-Type: application/json" \
              -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
              -d '{"timestamp":"'"$TS"'"}')
            BODY=$(cat "$BODY_FILE")
            BODY_TRUNCATED=$(printf '%s' "$BODY" | head -c 1000)

            echo "attempt=$ATTEMPT timestamp=$TS http_status=$STATUS"
            echo "body=$BODY_TRUNCATED"

            if [ "$STATUS" -ge 400 ]; then
              rm -f "$BODY_FILE"
              echo "::error::cron-tick returned HTTP $STATUS on attempt $ATTEMPT"
              exit 1
            fi

            PY_SCRIPT=$(mktemp)
            cat > "$PY_SCRIPT" << 'PYEOF'
import json, sys
try:
    with open(sys.argv[1], "r", encoding="utf-8") as f:
        data = json.load(f)
    print("STATUS=" + str(data.get("status", "unknown")))
except Exception:
    print("STATUS=unknown")
PYEOF
            RESULT=$(python3 "$PY_SCRIPT" "$BODY_FILE")
            rm -f "$PY_SCRIPT" "$BODY_FILE"

            echo "$RESULT"
            RESP_STATUS=$(echo "$RESULT" | awk -F= '/^STATUS=/{print $2}')

            if [ "$RESP_STATUS" = "noop" ]; then
              echo "Status is noop; no work pending. Stopping after attempt $ATTEMPT"
              break
            fi

            if [ "$ATTEMPT" -lt "$TICK_MAX_CALLS" ]; then
              echo "Work may be pending (status=$RESP_STATUS); sleeping ${TICK_SLEEP_SEC}s before next attempt"
              sleep "$TICK_SLEEP_SEC"
            else
              echo "Reached max attempts ($TICK_MAX_CALLS) with status=$RESP_STATUS"
            fi
          done
