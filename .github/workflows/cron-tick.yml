name: Cron Tick (every 1 minute)

on:
  schedule:
    - cron: "* * * * *"
  workflow_dispatch: {}

concurrency:
  group: cron-tick
  cancel-in-progress: false

jobs:
  cron-tick:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.CRON_TICK_URL }}" ]; then
            echo "::error::Secret CRON_TICK_URL is not configured. Go to Settings > Secrets and variables > Actions and add CRON_TICK_URL (the full URL of your cron-tick Edge Function, e.g. https://<project-id>.supabase.co/functions/v1/cron-tick)."
            exit 1
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "::error::Secret CRON_SECRET is not configured. Go to Settings > Secrets and variables > Actions and add CRON_SECRET (must match the CRON_SECRET Supabase secret)."
            exit 1
          fi

      - name: Call cron-tick
        run: |
          TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          BODY_FILE=$(mktemp)
          STATUS=$(curl -sS -o "$BODY_FILE" -w "%{http_code}" \
            --max-time 300 \
            -X POST "${{ secrets.CRON_TICK_URL }}" \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -d '{"timestamp":"'"$TS"'"}')
          BODY=$(cat "$BODY_FILE")
          BODY_TRUNCATED=$(printf '%s' "$BODY" | head -c 2000)
          rm -f "$BODY_FILE"

          echo "timestamp=$TS http_status=$STATUS"
          echo "body=$BODY_TRUNCATED"

          if [ "$STATUS" -ge 400 ]; then
            echo "::error::cron-tick returned HTTP $STATUS"
            exit 1
          fi

          echo "cron-tick completed successfully (HTTP $STATUS)"
